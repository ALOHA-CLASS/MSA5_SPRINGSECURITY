<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSRF ν† ν° - μ”μ²­</title>
</head>
<body>
    <h1>CSRF ν† ν° - μ”μ²­</h1>
    <!--
        π« CSRF ν† ν° ν—¤λ”
        FORM μ”μ²­ : _csrf           (νλΌλ―Έν„°β΅ν—¤λ”)
        AJAX μ”μ²­ : X-CSRF-TOKEN
    -->

    <h3>CSRF ν† ν° - FORM μ”μ²­</h3>
    <form action="/api/form" method="post">
        <!-- π’ CSRF TOKEN -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="text" name="name" id="name" placeholder="μ΄λ¦„">
        <button type="submit">FORM μ”μ²­</button>
    </form>

    <h3>CSRF ν† ν° - AJAX μ”μ²­</h3>
    <button type="button" onclick="ajax()">AJAX μ”μ²­</button>
    <button type="button" onclick="ajaxJQuery()">AJAX μ”μ²­ (jQuery)</button>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        // π’ CRSF TOKEN
        const csrfToken = "[[${_csrf.token}]]"

        function ajax() {
            let request = new XMLHttpRequest()
            let data = {
                "name" : document.getElementById("name").value
            }
            request.open("POST", "/api/ajax")
            request.setRequestHeader("Content-Type", "application/json")
            request.setRequestHeader("X-CSRF-TOKEN", csrfToken) // π’
            request.send( JSON.stringify(data) )

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    const response = request.responseText
                    alert(response)
                }
            }

        }

        function ajaxJQuery() {
            let data = {
                "name" : document.getElementById("name").value
            }

            $.ajax({
                type        : "POST",                   // μ”μ²­ λ©”μ†λ“
                url         : "/api/ajax",              // μ”μ²­ URL
                data        : JSON.stringify(data),     // λ°μ΄ν„°
                contentType : "application/json",       // μ”μ²­ λ°μ΄ν„° νƒ€μ…
                dataType    : "html",                   // μ‘λ‹µ λ°μ΄ν„° νƒ€μ…
                // μ”μ²­ μ „ μ„¤μ •
                beforeSend: function(xhr) {
                    /* π’ CSRF TOKEN μ„¤μ • */
                    xhr.setRequestHeader("X-CSRF-TOKEN", csrfToken)
                },
                // μ”μ²­ μ„±κ³µ
                success: function(response) {
                    alert(response)
                },
                // μ”μ²­ μ‹¤ν¨
                error: function(xhr, status, error) {
                    console.log("μ”μ²­μ— μ‹¤ν¨ν•μ€μµλ‹λ‹¤.");
                }

            })
        }
    </script>
</body>
</html>